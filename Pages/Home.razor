@page "/"
@inject IJSRuntime JS

<PageTitle>
    Home
</PageTitle>

<h1>The Booty Shakin Machine</h1>

<div class="controls">
    <button @onclick="StartEngine">1. Start Audio Engine</button>
    <button @onclick="TogglePlay">2. @(IsPlaying ? "Stop" : "Play")</button>
</div>

<div class="sequencer">
    @foreach (var track in Tracks)
    {
        <div class="track-row">
            <div class="track-name">@track.Name</div>

            <div class="steps">
                @for (int i = 0; i < 16; i++)
                {
                    // We need a local copy of the index for Blazor to bind correctly
                    int stepIndex = i;

                    // Check if the playhead is currently on this step
                    bool isCurrent = stepIndex == CurrentStep;

                    <div class="step-container @(isCurrent ? "current-step" : "")">
                        <input type="checkbox" @bind="track.Steps[stepIndex]" />
                    </div>
                }
            </div>
        </div>
    }
</div>

<style>
    .controls { margin-bottom: 20px; gap: 10px; display: flex; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; }

    .track-row { display: flex; align-items: center; margin-bottom: 10px; }
    .track-name { width: 80px; font-weight: bold; }

    .steps { display: flex; gap: 4px; }
    .step-container {
        padding: 4px;
        border: 2px solid #ccc;
        border-radius: 4px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    /* This highlights the step the playhead is currently on */
    .current-step {
        border-color: red;
        background-color: #ffe6e6;
    }

    input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
</style>

@code {
    private int CurrentStep = -1;
    private int BPM = 120;
    private bool IsPlaying = false;
    private CancellationTokenSource? _cts;
    private List<Track> Tracks = new();
    private IJSObjectReference? _module;
    private DotNetObjectReference<Home>? _objRef;

    protected override void OnInitialized()
    {
        Tracks.Add(new Track { Name = "Kick" });
        Tracks.Add(new Track { Name = "Snare" });
        Tracks.Add(new Track { Name = "HiHat" });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JS.InvokeAsync<IJSObjectReference>("import", "./js/audio.js");
            _objRef = DotNetObjectReference.Create(this);
        }
    }

    private async Task StartEngine()
        {
            if (_module != null)
            {
                // 1. Wake up the audio engine
                await _module.InvokeVoidAsync("initAudio");

                // 2. Load ALL the samples into memory
                await _module.InvokeVoidAsync("loadSample", "kick", "samples/kick.wav");
                await _module.InvokeVoidAsync("loadSample", "snare", "samples/snare.wav");
                await _module.InvokeVoidAsync("loadSample", "hihat", "samples/hihat.wav");

                // await _module.InvokeVoidAsync("setupMidi", _objRef);
            }
        }

    private async Task TogglePlay()
    {
        IsPlaying = !IsPlaying;
        if (IsPlaying)
        {
            _cts = new CancellationTokenSource();
            _ = PlayLoop(_cts.Token);
        }
        else
        {
            _cts?.Cancel();
        }
    }

    private async Task PlayLoop(CancellationToken token)
    {
        while (!token.IsCancellationRequested)
        {
            // Move to the next step FIRST, so we go from -1 to 0 on the first beat
            CurrentStep = (CurrentStep + 1) % 16;
            StateHasChanged();

            // Check every track to see if it has a hit on this specific step
            foreach (var track in Tracks)
            {
                 if (track.Steps[CurrentStep])
                 {
                     _ = _module?.InvokeVoidAsync("playSample", track.Name.ToLower());
                 }
            }

            // Wait for the exact amount of time before the next 16th note
            var interval = 60000 / BPM / 4;
            await Task.Delay(interval, token);
        }
    }
}
